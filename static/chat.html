<!DOCTYPE html>
<html>

<head>
	<title>Psychic-Enigma Chat</title>
	<link href="chat.css" rel="stylesheet" type="text/css">
  <meta name="viewport" content="width=device-width, initial-scale=1" /> 
</head>

<body bgcolor="#2C2F33">
<!--<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
	<script src="jquery-3.7.1.min.js"></script>

	<script src='chat.js'></script>

	<div id="messages"></div>
  <div id="bottom"></div>
  <div id='send'>
      <form id="sendform" action="">
          <button type=button class='mpbutton' id='uploadlabel' onCLick="alert('drag and drop files from your computer or from the web onto the message bar to add them');">+</button>

          <button type=button class='mpbutton' id='scriptlabel' onCLick="$('#m').append('<div contenteditable=false><div class=\'scripttype\' contenteditable=true>/*javascript*/<br><br></div><button onclick=\'let js = $(`<div/>`).html($(this).closest(`div`).find(`.scripttype`).html().replace(/<br>/g, `\n`)).text(); console.log(js); eval(js);\'>run</button></div>');">&lt;/&gt;</button>

          <span contenteditable=true id="m" autocomplete="off" disabled='true' ondrop="drop(event)" ondragover="allowDrop(event)">Sup fool!</span>

          <button type=submit id='sendbutton'>^</button> <!-- initially disabled until login -->
      </form>
  </div>

  <script>
    

    // $('#m').keydown(function...)
    document.onkeydown = function(e) { // hot keys while m bar is selected
      var evtobj = window.event? event : e
      if (evtobj.ctrlKey) {$('#m').focus()}
      if ($('#m').is(":focus")){ // only if m bar is selected
        
        if (evtobj.keyCode == 74 && evtobj.ctrlKey){ // pressing 'Ctrl + j'
          event.preventDefault(); // don't do normal programmed action of ctrl j
          $('#scriptlabel').click(); // run the onclick of the button

          // place cursor at line 2 in the scripttype box that appears
          let range = document.createRange();
          range.setStart($('#m .scripttype')[0], 2);
          range.setEnd($('#m .scripttype')[0], 2);
          let sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
        }
        if (evtobj.keyCode == 13 && !evtobj.shiftKey){ // pressing enter key without shift
          e.preventDefault(); // don't make newline
          $('#m').closest("form").submit(); // submit message
          $('#m').focus(); // refocus
          return false; // don't reload
        }
      }
    };


    document.addEventListener('paste', function (e) {
      let tg = e.target; // what is being pasted into
      // if ($('#m').is(":focus")){ // only if m bar is selected
        var clipboardData, pastedData;
        // let e = ev.originalEvent; // for jquery .bind() rather than addeventlistener
        // Stop data actually being pasted into div
        e.stopPropagation();
        e.preventDefault();

        // Get pasted data via clipboard API
        clipboardData = e.clipboardData || window.clipboardData;
        pastedData = clipboardData.getData('Text');

        // let tg = e.target;
        tg.innerHTML = tg.innerHTML.substring(0, window.getSelection().getRangeAt(0).startOffset) + pastedData + tg.innerHTML.substring(window.getSelection().getRangeAt(0).endOffset);
      // }
    });

  </script>
  </body>
</html>

